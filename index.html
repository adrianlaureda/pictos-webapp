<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <script>
        if (localStorage.getItem('darkMode') === 'false') {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pictos — Conversor de Texto a Pictogramas</title>

    <!-- Fuentes: Geist -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- mammoth.js - Leer .docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- docx.js - Generar .docx -->
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js"></script>

    <style>
        /* Reset y variables */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #fafafa;
            --bg-elevated: #ffffff;
            --text: #171717;
            --text-muted: #737373;
            --text-subtle: #a3a3a3;
            --border: #e5e5e5;
            --accent: #f59e0b;
            --accent-soft: #fef3c7;
            --success: #22c55e;
            --error: #ef4444;
            --radius: 12px;
            --radius-sm: 8px;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.08);
            --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark {
            --bg: #0a0a0a;
            --bg-elevated: #141414;
            --text: #fafafa;
            --text-muted: #a3a3a3;
            --text-subtle: #525252;
            --border: #262626;
            --accent: #fbbf24;
            --accent-soft: #451a0310;
            --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.2);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.4);
        }

        html {
            font-family: 'Instrument Sans', system-ui, sans-serif;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            transition: background var(--transition), color var(--transition);
        }

        /* Layout principal */
        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 2.5rem 1.5rem 3rem;
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 18px;
            height: 18px;
            color: #0a0a0a;
        }

        .logo-text {
            font-size: 1.125rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Botones */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            transition: all var(--transition);
            text-decoration: none;
        }

        .btn-icon {
            padding: 0.625rem;
        }

        .btn-icon svg {
            width: 18px;
            height: 18px;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
        }

        .btn-ghost:hover {
            background: var(--border);
            color: var(--text);
        }

        .btn-outline {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-outline:hover {
            background: var(--bg-elevated);
            border-color: var(--text-subtle);
        }

        .btn-primary {
            background: var(--accent);
            color: #0a0a0a;
            font-weight: 600;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            filter: none;
        }

        /* Indicador de pasos */
        .steps-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all var(--transition);
        }

        .step-dot.active {
            background: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-soft);
        }

        .step-dot.completed {
            background: var(--accent);
        }

        .step-line {
            width: 40px;
            height: 1px;
            background: var(--border);
        }

        /* Secciones */
        section {
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .section-heading {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .section-description {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        /* Textarea */
        .textarea-wrapper {
            position: relative;
            margin-bottom: 1.25rem;
        }

        textarea {
            width: 100%;
            min-height: 140px;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            font-family: inherit;
            line-height: 1.7;
            background: var(--bg-elevated);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            resize: vertical;
            transition: all var(--transition);
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        textarea::placeholder {
            color: var(--text-subtle);
        }

        /* Separador */
        .divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.25rem 0;
            color: var(--text-subtle);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Dropzone */
        .dropzone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 2rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition);
            margin-bottom: 1.75rem;
        }

        .dropzone:hover {
            border-color: var(--text-subtle);
            background: var(--bg-elevated);
        }

        .dropzone.dragover {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .dropzone-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 0.875rem;
            color: var(--text-subtle);
        }

        .dropzone-text {
            color: var(--text-muted);
            font-size: 0.9375rem;
        }

        .dropzone-text strong {
            color: var(--text);
        }

        .dropzone-file {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--accent);
            font-weight: 500;
        }

        /* Contenedor de palabras */
        .words-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            min-height: 120px;
            margin-bottom: 1.5rem;
            line-height: 2.2;
        }

        .word-token {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            margin: 0.125rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 150ms ease;
            font-size: 1rem;
        }

        .word-token:hover {
            background: var(--border);
        }

        .word-token.selected {
            background: var(--accent);
            color: #0a0a0a;
            font-weight: 500;
        }

        .word-token.punctuation {
            cursor: default;
            padding: 0 2px;
            margin: 0;
        }

        .word-token.punctuation:hover {
            background: transparent;
        }

        /* Acciones de sección */
        .section-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .action-group {
            display: flex;
            gap: 0.75rem;
        }

        /* Preview documento - siempre modo claro */
        .preview-wrapper {
            background: #e5e5e5;
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .dark .preview-wrapper {
            background: #1a1a1a;
        }

        .preview-document {
            background: white;
            color: #171717;
            box-shadow: var(--shadow-lg);
            max-width: 210mm;
            min-height: 200px;
            padding: 15mm 20mm;
            margin: 0 auto;
            border-radius: 2px;
            font-size: 14px;
            line-height: 1.8;
        }

        /* Picto en preview */
        .picto-container {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: bottom;
            margin: 4px 3px;
        }

        .picto-image {
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            background: white;
        }

        .picto-caption {
            font-size: 9px;
            color: #737373;
            margin-top: 3px;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
        }

        .no-picto {
            color: #a3a3a3;
            font-style: italic;
            position: relative;
        }

        .no-picto::after {
            content: 'Sin pictograma';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #171717;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            font-style: normal;
        }

        .no-picto:hover::after {
            opacity: 1;
        }

        /* Botón de cambiar picto */
        .picto-container {
            position: relative;
        }

        .picto-change-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 22px;
            height: 22px;
            padding: 0;
            border: 2px solid white;
            border-radius: 50%;
            background: #f59e0b;
            color: #0a0a0a;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.2s;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .picto-container:hover .picto-change-btn {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Grid de alternativas de pictos */
        .alternatives-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .alt-picto {
            padding: 0.5rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alt-picto:hover {
            border-color: var(--accent);
        }

        .alt-picto.selected {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .alt-picto img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
        }

        /* Loading state */
        .loading-state {
            text-align: center;
            padding: 3rem 2rem;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-muted);
            font-size: 0.9375rem;
            margin-bottom: 1rem;
        }

        .progress-bar {
            width: 200px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 0 auto;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            width: 100%;
            max-width: 360px;
            margin: 1rem;
            transform: scale(0.95);
            transition: transform var(--transition);
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition);
        }

        .modal-close:hover {
            background: var(--border);
            color: var(--text);
        }

        /* Radio buttons personalizados */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background var(--transition);
        }

        .radio-label:hover {
            background: var(--bg);
        }

        .radio-label input {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 50%;
            transition: all var(--transition);
            position: relative;
        }

        .radio-label input:checked {
            border-color: var(--accent);
            background: var(--accent);
        }

        .radio-label input:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: #0a0a0a;
            border-radius: 50%;
        }

        .radio-text {
            font-size: 0.9375rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.875rem 1.25rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 200;
        }

        .toast.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
            color: white;
        }

        .toast.error {
            background: var(--error);
            color: white;
        }

        .toast.info {
            background: var(--accent);
            color: #0a0a0a;
        }

        /* Utilidades */
        .hidden { display: none !important; }
        .center { text-align: center; }

        /* Estilos de impresión */
        @media print {
            @page {
                margin: 15mm 20mm;
            }
            body > * {
                display: none !important;
            }
            body {
                background: white !important;
            }
            #printContainer {
                display: block !important;
                width: 100% !important;
                padding: 0 !important;
                background: white !important;
                color: black !important;
            }
            #printContainer * {
                color: black !important;
            }
            #printContainer img {
                max-width: 80px !important;
            }
            #printContainer .picto-change-btn {
                display: none !important;
            }
            #printContainer .preview-document,
            #printContainer * {
                box-shadow: none !important;
            }
            .picto-inline {
                display: inline-flex !important;
                page-break-inside: avoid !important;
            }
        }

        /* Responsive */
        @media (max-width: 640px) {
            .container {
                padding: 1.5rem 1rem 2rem;
            }

            header {
                margin-bottom: 2rem;
            }

            .section-heading {
                font-size: 1.5rem;
            }

            .section-actions {
                flex-direction: column;
            }

            .action-group {
                width: 100%;
                justify-content: center;
            }

            .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                    </svg>
                </div>
                <span class="logo-text">Pictos</span>
            </div>
            <div class="header-actions">
                <button id="themeToggle" class="btn btn-icon btn-ghost" title="Cambiar tema">
                    <svg id="sunIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"/>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                    </svg>
                    <svg id="moonIcon" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
                <button id="settingsBtn" class="btn btn-icon btn-ghost" title="Configuración">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Indicador de pasos -->
        <div class="steps-indicator">
            <div id="stepDot1" class="step-dot active"></div>
            <div class="step-line"></div>
            <div id="stepDot2" class="step-dot"></div>
            <div class="step-line"></div>
            <div id="stepDot3" class="step-dot"></div>
        </div>

        <!-- Paso 1: Entrada de texto -->
        <section id="step1">
            <p class="section-title">Paso 1</p>
            <h1 class="section-heading">Carga tu actividad</h1>
            <p class="section-description">Pega el texto o sube un documento .docx para añadir pictogramas ARASAAC.</p>

            <div class="textarea-wrapper">
                <textarea
                    id="textInput"
                    placeholder="Escribe o pega aquí el texto de tu actividad..."
                ></textarea>
            </div>

            <div class="divider">o</div>

            <div id="dropzone" class="dropzone">
                <input type="file" id="fileInput" accept=".docx" class="hidden">
                <svg class="dropzone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <p class="dropzone-text">Arrastra un archivo <strong>.docx</strong> o haz clic para seleccionar</p>
                <p id="fileName" class="dropzone-file hidden"></p>
            </div>

            <div class="center">
                <button id="loadTextBtn" class="btn btn-primary">
                    Continuar
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </section>

        <!-- Paso 2: Selección de palabras -->
        <section id="step2" class="hidden">
            <p class="section-title">Paso 2</p>
            <h1 class="section-heading">Selecciona palabras</h1>
            <p class="section-description">Haz clic en las palabras que quieres convertir a pictogramas.</p>

            <div id="wordContainer" class="words-container"></div>

            <div class="section-actions">
                <button id="selectAllBtn" class="btn btn-outline">
                    Seleccionar todas
                </button>
                <div class="action-group">
                    <button id="backToStep1Btn" class="btn btn-ghost">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Volver
                    </button>
                    <button id="convertBtn" class="btn btn-primary" disabled>
                        Convertir
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </section>

        <!-- Paso 3: Previsualización -->
        <section id="step3" class="hidden">
            <p class="section-title">Paso 3</p>
            <h1 class="section-heading">Previsualización</h1>
            <p class="section-description">Revisa el resultado y descarga en el formato que prefieras.</p>

            <!-- Estado de carga -->
            <div id="loadingState" class="loading-state hidden">
                <div class="spinner"></div>
                <p id="loadingText" class="loading-text">Buscando pictogramas...</p>
                <div class="progress-bar">
                    <div id="progressBar" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Documento de previsualización -->
            <div id="previewContainer" class="hidden">
                <div class="preview-wrapper">
                    <div id="previewDocument" class="preview-document"></div>
                </div>

                <div class="section-actions" style="justify-content: center;">
                    <button id="backToStep2Btn" class="btn btn-ghost">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Editar
                    </button>
                    <button id="downloadDocxBtn" class="btn btn-outline">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        .docx
                    </button>
                    <button id="downloadPdfBtn" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        .pdf
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal de configuración -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Configuración</h2>
                <button id="closeModalBtn" class="modal-close">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 1rem;">Tamaño de pictogramas</p>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="pictoSize" value="40">
                    <span class="radio-text">Pequeño (40px)</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="pictoSize" value="60" checked>
                    <span class="radio-text">Mediano (60px)</span>
                </label>
                <label class="radio-label">
                    <input type="radio" name="pictoSize" value="80">
                    <span class="radio-text">Grande (80px)</span>
                </label>
            </div>

            <div class="modal-actions">
                <button id="cancelSettingsBtn" class="btn btn-ghost">Cancelar</button>
                <button id="saveSettingsBtn" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Modal de alternativas de pictos -->
    <div id="alternativesModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Elige pictograma para: <span id="alternativesWord" style="color:var(--accent);font-weight:600"></span></h3>
                <button class="btn btn-icon btn-ghost" onclick="closeAlternativesModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="alternativesGrid" class="alternatives-grid"></div>
        </div>
    </div>

    <script>
        // Configuración API de lematización (Render)
        const LEMMATIZER_API = 'https://spacy-lemmatizer-r1t5.onrender.com';

        // Estado global
        const state = {
            text: '',
            tokens: [],
            selectedWords: new Set(),
            pictos: new Map(),           // word -> { url, alternatives: [{id, url}] }
            translations: new Map(),
            lemmas: new Map(),           // word -> lemma (del servidor SpaCy)
            pictoSize: parseInt(localStorage.getItem('pictoSize') || '60'),
            darkMode: localStorage.getItem('darkMode') !== 'false',
            esGallego: false                // detectado automáticamente
        };

        // Elementos del DOM
        const $ = id => document.getElementById(id);
        const elements = {
            textInput: $('textInput'),
            fileInput: $('fileInput'),
            dropzone: $('dropzone'),
            fileName: $('fileName'),
            loadTextBtn: $('loadTextBtn'),
            wordContainer: $('wordContainer'),
            selectAllBtn: $('selectAllBtn'),
            convertBtn: $('convertBtn'),
            backToStep1Btn: $('backToStep1Btn'),
            backToStep2Btn: $('backToStep2Btn'),
            loadingState: $('loadingState'),
            loadingText: $('loadingText'),
            progressBar: $('progressBar'),
            previewContainer: $('previewContainer'),
            previewDocument: $('previewDocument'),
            downloadDocxBtn: $('downloadDocxBtn'),
            downloadPdfBtn: $('downloadPdfBtn'),
            themeToggle: $('themeToggle'),
            moonIcon: $('moonIcon'),
            sunIcon: $('sunIcon'),
            settingsBtn: $('settingsBtn'),
            settingsModal: $('settingsModal'),
            closeModalBtn: $('closeModalBtn'),
            cancelSettingsBtn: $('cancelSettingsBtn'),
            saveSettingsBtn: $('saveSettingsBtn'),
            toast: $('toast'),
            step1: $('step1'),
            step2: $('step2'),
            step3: $('step3'),
            stepDot1: $('stepDot1'),
            stepDot2: $('stepDot2'),
            stepDot3: $('stepDot3')
        };

        // Mostrar toast
        function showToast(message, type = 'info') {
            elements.toast.textContent = message;
            elements.toast.className = `toast ${type} visible`;
            setTimeout(() => elements.toast.classList.remove('visible'), 3000);
        }

        // Tokenizar texto
        function tokenizeText(text) {
            const tokens = [];
            const regex = /(\S+|\n)/g;
            let match;

            while ((match = regex.exec(text)) !== null) {
                const token = match[1];

                if (token === '\n') {
                    tokens.push({ type: 'newline', value: '\n' });
                    continue;
                }

                const leadingPunct = token.match(/^[^\wáéíóúüñÁÉÍÓÚÜÑ]+/);
                const trailingPunct = token.match(/[^\wáéíóúüñÁÉÍÓÚÜÑ]+$/);
                let word = token;

                if (leadingPunct) {
                    tokens.push({ type: 'punctuation', value: leadingPunct[0] });
                    word = word.slice(leadingPunct[0].length);
                }

                if (trailingPunct && word.length > trailingPunct[0].length) {
                    const trail = trailingPunct[0];
                    word = word.slice(0, -trail.length);
                    if (word) tokens.push({ type: 'word', value: word });
                    tokens.push({ type: 'punctuation', value: trail });
                } else if (word) {
                    if (/^[^\wáéíóúüñÁÉÍÓÚÜÑ]+$/.test(word)) {
                        tokens.push({ type: 'punctuation', value: word });
                    } else {
                        tokens.push({ type: 'word', value: word });
                    }
                }
            }
            return tokens;
        }

        // Detectar si el texto es predominantemente gallego
        // Busca palabras exclusivamente gallegas (no existen en español)
        const marcadoresGallegos = new Set([
            // Sustantivos que solo existen en gallego
            'neno', 'nena', 'nenos', 'nenas', 'mazá', 'auga', 'leite', 'peixe',
            'can', 'galiña', 'ovella', 'escola', 'xoguete', 'cadeira', 'caderno',
            'boneca', 'paxaro', 'cabalo', 'coello', 'fillo', 'filla', 'fillos',
            'nai', 'pai', 'avó', 'avoa', 'irmán', 'irmá', 'veciño', 'veciña',
            'mestre', 'mestra', 'choiva', 'neve', 'vento', 'árbore', 'folla',
            'herba', 'praia', 'ceo', 'lúa', 'estrela', 'cociña', 'cuarto',
            // Adjetivos exclusivamente gallegos
            'vermello', 'vermella', 'branco', 'branca', 'amarelo', 'amarela',
            'pequeno', 'pequena', 'baixo', 'baixa', 'novo', 'nova', 'vello', 'vella',
            'quente', 'limpo', 'limpa', 'bo', 'boa',
            // Pronombres gallegos
            'eu', 'ti', 'ela', 'eles', 'elas', 'nós', 'vós',
            'meu', 'teu', 'seu', 'miña', 'túa', 'súa',
            // Adverbios/partículas exclusivamente gallegas
            'hoxe', 'onte', 'mañá', 'agora', 'tamén', 'mesmo', 'mesma',
            'sempre', 'despois', 'lonxe', 'preto', 'máis', 'moito', 'pouco',
            // Contracciones (solo existen en gallego)
            'do', 'da', 'dos', 'das', 'ao', 'aos', 'co', 'coa', 'cos', 'coas',
            'polo', 'pola', 'polos', 'polas', 'unha',
            // Verbos exclusivamente gallegos
            'falar', 'xogar', 'chorar', 'debuxar', 'facer', 'ter', 'poñer',
            'escoitar', 'camiñar', 'traballar', 'estudar', 'ensinar'
        ]);

        function detectarIdioma(tokens) {
            let gallegoCount = 0;
            let totalWords = 0;
            for (const token of tokens) {
                if (token.type !== 'word') continue;
                totalWords++;
                if (marcadoresGallegos.has(token.value.toLowerCase())) gallegoCount++;
            }
            // Si al menos 1 palabra es exclusivamente gallega, asumir gallego
            return gallegoCount >= 1;
        }

        // ═══════════════════════════════════════════════════════════════
        // NORMALIZADOR DE PALABRAS PARA ARASAAC
        // Convierte cualquier palabra a su forma de diccionario
        // ═══════════════════════════════════════════════════════════════

        // Diccionario gallego → español (sustantivos, adjetivos, adverbios)
        const gallegoEspanol = {
            // Personas
            'neno': 'niño', 'nena': 'niña', 'nenos': 'niños', 'nenas': 'niñas',
            'home': 'hombre', 'muller': 'mujer', 'persoa': 'persona',
            'pai': 'padre', 'nai': 'madre', 'fillo': 'hijo', 'filla': 'hija', 'fillos': 'hijos', 'fillas': 'hijas',
            'irmán': 'hermano', 'irmá': 'hermana', 'avó': 'abuelo', 'avoa': 'abuela',
            'tío': 'tío', 'tía': 'tía', 'primo': 'primo', 'prima': 'prima',
            'mestre': 'maestro', 'mestra': 'maestra', 'alumno': 'alumno', 'alumna': 'alumna',
            'amigo': 'amigo', 'amiga': 'amiga', 'veciño': 'vecino', 'veciña': 'vecina',

            // Animales
            'can': 'perro', 'gato': 'gato', 'paxaro': 'pájaro', 'peixe': 'pez',
            'vaca': 'vaca', 'cabalo': 'caballo', 'porco': 'cerdo', 'galiña': 'gallina',
            'ovella': 'oveja', 'rato': 'ratón', 'coello': 'conejo',

            // Comida
            'auga': 'agua', 'leite': 'leche', 'pan': 'pan', 'carne': 'carne',
            'mazá': 'manzana', 'laranxa': 'naranja', 'pera': 'pera', 'uva': 'uva',
            'queixo': 'queso', 'ovo': 'huevo', 'arroz': 'arroz', 'pataca': 'patata',
            'verdura': 'verdura', 'froita': 'fruta', 'peixe': 'pescado',
            'xeado': 'helado', 'doce': 'dulce', 'torta': 'tarta',

            // Casa y objetos
            'casa': 'casa', 'cuarto': 'habitación', 'cociña': 'cocina', 'baño': 'baño',
            'porta': 'puerta', 'ventá': 'ventana', 'cadeira': 'silla', 'mesa': 'mesa',
            'cama': 'cama', 'sofá': 'sofá', 'televisión': 'televisión',
            'teléfono': 'teléfono', 'ordenador': 'ordenador', 'libro': 'libro',
            'caderno': 'cuaderno', 'lapis': 'lápiz', 'bolígrafo': 'bolígrafo',
            'xoguete': 'juguete', 'boneca': 'muñeca', 'pelota': 'pelota',

            // Escuela
            'escola': 'escuela', 'clase': 'clase', 'aula': 'aula',
            'recreo': 'recreo', 'deberes': 'deberes', 'exame': 'examen',

            // Naturaleza
            'sol': 'sol', 'lúa': 'luna', 'estrela': 'estrella', 'ceo': 'cielo',
            'nube': 'nube', 'choiva': 'lluvia', 'neve': 'nieve', 'vento': 'viento',
            'árbore': 'árbol', 'flor': 'flor', 'herba': 'hierba', 'folla': 'hoja',
            'río': 'río', 'mar': 'mar', 'praia': 'playa', 'monte': 'montaña',

            // Colores
            'branco': 'blanco', 'negro': 'negro', 'vermello': 'rojo', 'azul': 'azul',
            'verde': 'verde', 'amarelo': 'amarillo', 'laranxa': 'naranja', 'rosa': 'rosa',
            'marrón': 'marrón', 'gris': 'gris', 'violeta': 'violeta',

            // Adjetivos
            'grande': 'grande', 'pequeno': 'pequeño', 'alto': 'alto', 'baixo': 'bajo',
            'bo': 'bueno', 'malo': 'malo', 'bonito': 'bonito', 'feo': 'feo',
            'novo': 'nuevo', 'vello': 'viejo', 'quente': 'caliente', 'frío': 'frío',
            'limpo': 'limpio', 'sucio': 'sucio', 'rápido': 'rápido', 'lento': 'lento',
            'feliz': 'feliz', 'triste': 'triste', 'contento': 'contento', 'enfadado': 'enfadado',

            // Tiempo y lugar
            'hoxe': 'hoy', 'mañá': 'mañana', 'onte': 'ayer', 'agora': 'ahora',
            'sempre': 'siempre', 'nunca': 'nunca', 'despois': 'después', 'antes': 'antes',
            'aquí': 'aquí', 'alí': 'allí', 'lonxe': 'lejos', 'preto': 'cerca',

            // Otros
            'si': 'sí', 'non': 'no', 'e': 'y', 'ou': 'o', 'con': 'con', 'sen': 'sin',
            'un': 'un', 'unha': 'una', 'o': 'el', 'a': 'la', 'os': 'los', 'as': 'las',
            'este': 'este', 'esta': 'esta', 'ese': 'ese', 'esa': 'esa',
            'moito': 'mucho', 'pouco': 'poco', 'todo': 'todo', 'nada': 'nada',
            // Palabras problemáticas por subcadenas
            'onte': 'ayer', 'porque': 'porque',
            // Pronombres gallegos (críticos - evitar falsos positivos)
            'eu': 'yo', 'ti': 'tú', 'el': 'él', 'ela': 'ella',
            'nós': 'nosotros', 'vós': 'vosotros', 'eles': 'ellos', 'elas': 'ellas',
            'me': 'me', 'che': 'te', 'lle': 'le', 'nos': 'nos', 'lles': 'les',
            'meu': 'mío', 'teu': 'tuyo', 'seu': 'suyo',
            'miña': 'mía', 'túa': 'tuya', 'súa': 'suya',
            'meus': 'míos', 'teus': 'tuyos', 'seus': 'suyos',
            'miñas': 'mías', 'túas': 'tuyas', 'súas': 'suyas',
            // Contracciones gallegas
            'do': 'del', 'da': 'de la', 'dos': 'de los', 'das': 'de las',
            'ao': 'al', 'á': 'a la', 'aos': 'a los', 'ás': 'a las',
            'no': 'en el', 'na': 'en la', 'nos': 'en los', 'nas': 'en las',
            'co': 'con el', 'coa': 'con la', 'cos': 'con los', 'coas': 'con las',
            'polo': 'por el', 'pola': 'por la', 'polos': 'por los', 'polas': 'por las',
            // Adverbios, conjunciones y otros
            'mesmo': 'mismo', 'mesma': 'misma', 'tamén': 'también',
            'así': 'así', 'ben': 'bien', 'mal': 'mal', 'máis': 'más', 'menos': 'menos',
            'mentres': 'mientras', 'despois': 'después', 'agora': 'ahora',
            'hoxe': 'hoy', 'onte': 'ayer', 'sempre': 'siempre', 'nunca': 'nunca',
            'lonxe': 'lejos', 'preto': 'cerca', 'arriba': 'arriba', 'abaixo': 'abajo',
            'fóra': 'fuera', 'dentro': 'dentro', 'diante': 'delante', 'detrás': 'detrás',
            'moito': 'mucho', 'moita': 'mucha', 'pouco': 'poco', 'pouca': 'poca',
            // Sustantivos irregulares (no cubiertos por reglas morfológicas)
            'rapaz': 'chico', 'rapaza': 'chica', 'rapaces': 'chicos',
            'corpo': 'cuerpo', 'ollo': 'ojo', 'ollos': 'ojos',
            'roupa': 'ropa', 'xantar': 'comida', 'cea': 'cena', 'almorzo': 'desayuno',
            'fillo': 'hijo', 'filla': 'hija', 'fillos': 'hijos', 'fillas': 'hijas',
            'cidade': 'ciudad', 'cidades': 'ciudades',
            // Infinitivos gallegos (distintos del español) para deconjugación
            'xogar': 'jugar', 'falar': 'hablar', 'durmir': 'dormir',
            'saír': 'salir', 'vir': 'venir', 'dicir': 'decir',
            'poñer': 'poner', 'ter': 'tener', 'facer': 'hacer',
            'camiñar': 'caminar', 'escoitar': 'escuchar', 'levar': 'llevar',
            'debuxar': 'dibujar', 'pechar': 'cerrar', 'mercar': 'comprar',
            'traballar': 'trabajar', 'estudar': 'estudiar', 'ensinar': 'enseñar',
            'lembrar': 'recordar', 'esquecer': 'olvidar', 'coller': 'coger',
            'empurrar': 'empujar', 'baixar': 'bajar', 'voar': 'volar',
            'ler': 'leer', 'rir': 'reír', 'pedir': 'pedir', 'seguir': 'seguir',
            'durmir': 'dormir', 'morrer': 'morir', 'nacer': 'nacer',
            'crecer': 'crecer', 'vivir': 'vivir', 'sentir': 'sentir',
            'caer': 'caer', 'subir': 'subir', 'cortar': 'cortar',
            'limpar': 'limpiar', 'cociñar': 'cocinar', 'conducir': 'conducir',
            'agradecer': 'agradecer', 'coñecer': 'conocer', 'pertencer': 'pertenecer',
            'aparecer': 'aparecer', 'ofrecer': 'ofrecer'
        };

        // Verbos gallegos de emociones y acciones comunes
        const verbosGallegoAdicionales = {
            // Chorar (llorar)
            'choro': 'llorar', 'choras': 'llorar', 'chora': 'llorar', 'choramos': 'llorar', 'choran': 'llorar',
            'chorei': 'llorar', 'choraches': 'llorar', 'chorou': 'llorar', 'choramos': 'llorar', 'choraron': 'llorar',
            'chorar': 'llorar',
            // Rir (reír)
            'río': 'reír', 'ris': 'reír', 'ri': 'reír', 'rimos': 'reír', 'rin': 'reír',
            'rin': 'reír', 'riches': 'reír', 'riu': 'reír', 'riron': 'reír', 'rir': 'reír',
            // Cantar
            'canto': 'cantar', 'cantas': 'cantar', 'canta': 'cantar', 'cantamos': 'cantar', 'cantan': 'cantar',
            'cantei': 'cantar', 'cantou': 'cantar', 'cantaron': 'cantar',
            // Bailar
            'bailo': 'bailar', 'bailas': 'bailar', 'baila': 'bailar', 'bailamos': 'bailar', 'bailan': 'bailar',
            'bailei': 'bailar', 'bailou': 'bailar', 'bailaron': 'bailar',
            // Pintar
            'pinto': 'pintar', 'pintas': 'pintar', 'pinta': 'pintar', 'pintamos': 'pintar', 'pintan': 'pintar',
            'pintei': 'pintar', 'pintou': 'pintar', 'pintaron': 'pintar',
            // Debuxar (dibujar)
            'debuxo': 'dibujar', 'debuxas': 'dibujar', 'debuxa': 'dibujar', 'debuxamos': 'dibujar', 'debuxan': 'dibujar',
            'debuxei': 'dibujar', 'debuxou': 'dibujar', 'debuxaron': 'dibujar', 'debuxar': 'dibujar',
            // Nadar
            'nado': 'nadar', 'nadas': 'nadar', 'nada': 'nadar', 'nadamos': 'nadar', 'nadan': 'nadar',
            'nadei': 'nadar', 'nadou': 'nadar', 'nadaron': 'nadar',
            // Saltar
            'salto': 'saltar', 'saltas': 'saltar', 'salta': 'saltar', 'saltamos': 'saltar', 'saltan': 'saltar',
            'saltei': 'saltar', 'saltou': 'saltar', 'saltaron': 'saltar',
            // Traballar (trabajar)
            'traballo': 'trabajar', 'traballes': 'trabajar', 'traballa': 'trabajar', 'traballamos': 'trabajar', 'traballan': 'trabajar',
            'trabellei': 'trabajar', 'trabellou': 'trabajar', 'traballar': 'trabajar',
            // Estudar (estudiar)
            'estudo': 'estudiar', 'estudas': 'estudiar', 'estuda': 'estudiar', 'estudamos': 'estudiar', 'estudan': 'estudiar',
            'estudei': 'estudiar', 'estudou': 'estudiar', 'estudar': 'estudiar',
            // Aprender
            'aprendo': 'aprender', 'aprendes': 'aprender', 'aprende': 'aprender', 'aprendemos': 'aprender', 'aprenden': 'aprender',
            'aprendín': 'aprender', 'aprendeu': 'aprender', 'aprenderon': 'aprender'
        };

        // Diccionario de verbos gallegos conjugados → español infinitivo
        const verbosGallegoInfinitivo = {
            // Comer (gallego)
            'como': 'comer', 'comes': 'comer', 'come': 'comer', 'comemos': 'comer', 'comedes': 'comer', 'comen': 'comer',
            'comía': 'comer', 'comías': 'comer', 'comiamos': 'comer', 'comiades': 'comer', 'comían': 'comer',
            'comín': 'comer', 'comiches': 'comer', 'comeu': 'comer', 'comemos': 'comer', 'comestes': 'comer', 'comeron': 'comer',

            // Beber (gallego)
            'bebo': 'beber', 'bebes': 'beber', 'bebe': 'beber', 'bebemos': 'beber', 'bebedes': 'beber', 'beben': 'beber',
            'bebeu': 'beber', 'beberon': 'beber',

            // Durmir (gallego → dormir español)
            'durmo': 'dormir', 'durmes': 'dormir', 'durme': 'dormir', 'durmimos': 'dormir', 'durmides': 'dormir', 'durmen': 'dormir',
            'durmiu': 'dormir', 'durmiron': 'dormir', 'durmir': 'dormir',

            // Xogar (gallego → jugar español) - incluye gerundio
            'xogo': 'jugar', 'xogas': 'jugar', 'xoga': 'jugar', 'xogamos': 'jugar', 'xogades': 'jugar', 'xogan': 'jugar',
            'xogou': 'jugar', 'xogaron': 'jugar', 'xogar': 'jugar', 'xogando': 'jugar', 'xogado': 'jugar',

            // Falar (gallego → hablar español)
            'falo': 'hablar', 'falas': 'hablar', 'fala': 'hablar', 'falamos': 'hablar', 'falades': 'hablar', 'falan': 'hablar',
            'falou': 'hablar', 'falaron': 'hablar', 'falar': 'hablar',

            // Andar/Camiñar (gallego → caminar español)
            'camiño': 'caminar', 'camiñas': 'caminar', 'camiña': 'caminar', 'camiñamos': 'caminar', 'camiñan': 'caminar',
            'camiñou': 'caminar', 'camiñaron': 'caminar', 'camiñar': 'caminar',

            // Escoitar (gallego → escuchar español)
            'escoito': 'escuchar', 'escoitas': 'escuchar', 'escoita': 'escuchar', 'escoitamos': 'escuchar', 'escoitan': 'escuchar',
            'escoitou': 'escuchar', 'escoitaron': 'escuchar', 'escoitar': 'escuchar',

            // Mirar/Ver (gallego)
            'miro': 'mirar', 'miras': 'mirar', 'mira': 'mirar', 'miramos': 'mirar', 'miran': 'mirar',
            'mirou': 'mirar', 'miraron': 'mirar',
            'vexo': 'ver', 'ves': 'ver', 've': 'ver', 'vemos': 'ver', 'ven': 'ver',
            'viu': 'ver', 'viron': 'ver',

            // Ir (gallego)
            'vou': 'ir', 'vas': 'ir', 'vai': 'ir', 'imos': 'ir', 'ides': 'ir', 'van': 'ir',
            'fun': 'ir', 'fuches': 'ir', 'foi': 'ir', 'fomos': 'ir', 'fostes': 'ir', 'foron': 'ir',

            // Ter (gallego → tener español)
            'teño': 'tener', 'tes': 'tener', 'ten': 'tener', 'temos': 'tener', 'tendes': 'tener', 'teñen': 'tener',
            'tiven': 'tener', 'tiveches': 'tener', 'tivo': 'tener', 'tivemos': 'tener', 'ter': 'tener',

            // Facer (gallego → hacer español)
            'fago': 'hacer', 'fas': 'hacer', 'fai': 'hacer', 'facemos': 'hacer', 'facedes': 'hacer', 'fan': 'hacer',
            'fixen': 'hacer', 'fixeches': 'hacer', 'fixo': 'hacer', 'fixemos': 'hacer', 'facer': 'hacer',

            // Querer (gallego)
            'quero': 'querer', 'queres': 'querer', 'quere': 'querer', 'queremos': 'querer', 'queren': 'querer',
            'quixen': 'querer', 'quixo': 'querer', 'quixeron': 'querer',

            // Poder (gallego)
            'podo': 'poder', 'podes': 'poder', 'pode': 'poder', 'podemos': 'poder', 'poden': 'poder',
            'puiden': 'poder', 'puido': 'poder', 'puideron': 'poder',

            // Saber (gallego)
            'sei': 'saber', 'sabes': 'saber', 'sabe': 'saber', 'sabemos': 'saber', 'saben': 'saber',
            'souben': 'saber', 'soubo': 'saber', 'souberon': 'saber'
        };

        // Diccionario de verbos españoles conjugados → infinitivo
        const verbosEspanolInfinitivo = {
            // Comer
            'como': 'comer', 'comes': 'comer', 'come': 'comer', 'comemos': 'comer', 'coméis': 'comer', 'comen': 'comer',
            'comía': 'comer', 'comías': 'comer', 'comíamos': 'comer', 'comíais': 'comer', 'comían': 'comer',
            'comí': 'comer', 'comiste': 'comer', 'comió': 'comer', 'comisteis': 'comer', 'comieron': 'comer',
            'comeré': 'comer', 'comerás': 'comer', 'comerá': 'comer', 'comeremos': 'comer', 'comerán': 'comer',
            'comería': 'comer', 'comerías': 'comer', 'comeríamos': 'comer', 'comerían': 'comer',
            'coma': 'comer', 'comas': 'comer', 'comamos': 'comer', 'coman': 'comer',
            'comiendo': 'comer', 'comido': 'comer',

            // Beber
            'bebo': 'beber', 'bebes': 'beber', 'bebe': 'beber', 'bebemos': 'beber', 'bebéis': 'beber', 'beben': 'beber',
            'bebía': 'beber', 'bebí': 'beber', 'bebiste': 'beber', 'bebió': 'beber', 'bebieron': 'beber',
            'beberé': 'beber', 'beberá': 'beber', 'beberán': 'beber',
            'bebiendo': 'beber', 'bebido': 'beber',

            // Dormir
            'duermo': 'dormir', 'duermes': 'dormir', 'duerme': 'dormir', 'dormimos': 'dormir', 'dormís': 'dormir', 'duermen': 'dormir',
            'dormía': 'dormir', 'dormí': 'dormir', 'dormiste': 'dormir', 'durmió': 'dormir', 'durmieron': 'dormir',
            'dormiré': 'dormir', 'dormirá': 'dormir', 'dormirán': 'dormir',
            'durmiendo': 'dormir', 'dormido': 'dormir',

            // Jugar (incluye todas las formas)
            'juego': 'jugar', 'juegas': 'jugar', 'juega': 'jugar', 'jugamos': 'jugar', 'jugáis': 'jugar', 'juegan': 'jugar',
            'jugaba': 'jugar', 'jugabas': 'jugar', 'jugábamos': 'jugar', 'jugaban': 'jugar',
            'jugué': 'jugar', 'jugaste': 'jugar', 'jugó': 'jugar', 'jugaron': 'jugar',
            'jugaré': 'jugar', 'jugarás': 'jugar', 'jugará': 'jugar', 'jugaremos': 'jugar', 'jugarán': 'jugar',
            'jugaría': 'jugar', 'jugarías': 'jugar', 'jugaríamos': 'jugar', 'jugarían': 'jugar',
            'jugando': 'jugar', 'jugado': 'jugar',

            // Hablar
            'hablo': 'hablar', 'hablas': 'hablar', 'habla': 'hablar', 'hablamos': 'hablar', 'habláis': 'hablar', 'hablan': 'hablar',
            'hablaba': 'hablar', 'hablé': 'hablar', 'hablaste': 'hablar', 'habló': 'hablar', 'hablaron': 'hablar',
            'hablaré': 'hablar', 'hablará': 'hablar', 'hablarán': 'hablar',
            'hablando': 'hablar', 'hablado': 'hablar',

            // Caminar
            'camino': 'caminar', 'caminas': 'caminar', 'camina': 'caminar', 'caminamos': 'caminar', 'caminan': 'caminar',
            'caminaba': 'caminar', 'caminé': 'caminar', 'caminó': 'caminar', 'caminaron': 'caminar',
            'caminando': 'caminar', 'caminado': 'caminar',

            // Escuchar
            'escucho': 'escuchar', 'escuchas': 'escuchar', 'escucha': 'escuchar', 'escuchamos': 'escuchar', 'escuchan': 'escuchar',
            'escuchaba': 'escuchar', 'escuché': 'escuchar', 'escuchó': 'escuchar', 'escucharon': 'escuchar',
            'escuchando': 'escuchar', 'escuchado': 'escuchar',

            // Mirar
            'miro': 'mirar', 'miras': 'mirar', 'mira': 'mirar', 'miramos': 'mirar', 'miran': 'mirar',
            'miraba': 'mirar', 'miré': 'mirar', 'miró': 'mirar', 'miraron': 'mirar',
            'mirando': 'mirar', 'mirado': 'mirar',

            // Ver
            'veo': 'ver', 'ves': 'ver', 've': 'ver', 'vemos': 'ver', 'veis': 'ver', 'ven': 'ver',
            'veía': 'ver', 'vi': 'ver', 'viste': 'ver', 'vio': 'ver', 'vieron': 'ver',
            'veré': 'ver', 'verá': 'ver', 'verán': 'ver',
            'viendo': 'ver', 'visto': 'ver',

            // Ir
            'voy': 'ir', 'vas': 'ir', 'va': 'ir', 'vamos': 'ir', 'vais': 'ir', 'van': 'ir',
            'iba': 'ir', 'fui': 'ir', 'fuiste': 'ir', 'fue': 'ir', 'fuimos': 'ir', 'fueron': 'ir',
            'iré': 'ir', 'irá': 'ir', 'irán': 'ir',
            'yendo': 'ir', 'ido': 'ir',

            // Tener
            'tengo': 'tener', 'tienes': 'tener', 'tiene': 'tener', 'tenemos': 'tener', 'tenéis': 'tener', 'tienen': 'tener',
            'tenía': 'tener', 'tuve': 'tener', 'tuviste': 'tener', 'tuvo': 'tener', 'tuvieron': 'tener',
            'tendré': 'tener', 'tendrá': 'tener', 'tendrán': 'tener',
            'teniendo': 'tener', 'tenido': 'tener',

            // Hacer
            'hago': 'hacer', 'haces': 'hacer', 'hace': 'hacer', 'hacemos': 'hacer', 'hacéis': 'hacer', 'hacen': 'hacer',
            'hacía': 'hacer', 'hice': 'hacer', 'hiciste': 'hacer', 'hizo': 'hacer', 'hicieron': 'hacer',
            'haré': 'hacer', 'hará': 'hacer', 'harán': 'hacer',
            'haciendo': 'hacer', 'hecho': 'hacer',

            // Ser
            'soy': 'ser', 'eres': 'ser', 'es': 'ser', 'somos': 'ser', 'sois': 'ser', 'son': 'ser',
            'era': 'ser', 'fui': 'ser', 'fue': 'ser', 'fueron': 'ser',
            'seré': 'ser', 'será': 'ser', 'serán': 'ser',
            'siendo': 'ser', 'sido': 'ser',

            // Estar
            'estoy': 'estar', 'estás': 'estar', 'está': 'estar', 'estamos': 'estar', 'están': 'estar',
            'estaba': 'estar', 'estuve': 'estar', 'estuvo': 'estar', 'estuvieron': 'estar',
            'estaré': 'estar', 'estará': 'estar', 'estarán': 'estar',
            'estando': 'estar', 'estado': 'estar',

            // Querer
            'quiero': 'querer', 'quieres': 'querer', 'quiere': 'querer', 'queremos': 'querer', 'quieren': 'querer',
            'quería': 'querer', 'quise': 'querer', 'quiso': 'querer', 'quisieron': 'querer',
            'querré': 'querer', 'querrá': 'querer', 'querrán': 'querer',
            'queriendo': 'querer', 'querido': 'querer',

            // Poder
            'puedo': 'poder', 'puedes': 'poder', 'puede': 'poder', 'podemos': 'poder', 'pueden': 'poder',
            'podía': 'poder', 'pude': 'poder', 'pudo': 'poder', 'pudieron': 'poder',
            'podré': 'poder', 'podrá': 'poder', 'podrán': 'poder',
            'pudiendo': 'poder', 'podido': 'poder',

            // Saber
            'sé': 'saber', 'sabes': 'saber', 'sabe': 'saber', 'sabemos': 'saber', 'saben': 'saber',
            'sabía': 'saber', 'supe': 'saber', 'supo': 'saber', 'supieron': 'saber',
            'sabré': 'saber', 'sabrá': 'saber', 'sabrán': 'saber',
            'sabiendo': 'saber', 'sabido': 'saber',

            // Dar
            'doy': 'dar', 'das': 'dar', 'da': 'dar', 'damos': 'dar', 'dan': 'dar',
            'daba': 'dar', 'di': 'dar', 'diste': 'dar', 'dio': 'dar', 'dieron': 'dar',
            'daré': 'dar', 'dará': 'dar', 'darán': 'dar',
            'dando': 'dar', 'dado': 'dar',

            // Leer
            'leo': 'leer', 'lees': 'leer', 'lee': 'leer', 'leemos': 'leer', 'leen': 'leer',
            'leía': 'leer', 'leí': 'leer', 'leyó': 'leer', 'leyeron': 'leer',
            'leeré': 'leer', 'leerá': 'leer', 'leerán': 'leer',
            'leyendo': 'leer', 'leído': 'leer',

            // Escribir
            'escribo': 'escribir', 'escribes': 'escribir', 'escribe': 'escribir', 'escribimos': 'escribir', 'escriben': 'escribir',
            'escribía': 'escribir', 'escribí': 'escribir', 'escribió': 'escribir', 'escribieron': 'escribir',
            'escribiré': 'escribir', 'escribirá': 'escribir', 'escribirán': 'escribir',
            'escribiendo': 'escribir', 'escrito': 'escribir',

            // Correr
            'corro': 'correr', 'corres': 'correr', 'corre': 'correr', 'corremos': 'correr', 'corren': 'correr',
            'corría': 'correr', 'corrí': 'correr', 'corrió': 'correr', 'corrieron': 'correr',
            'correré': 'correr', 'correrá': 'correr', 'correrán': 'correr',
            'corriendo': 'correr', 'corrido': 'correr',

            // Salir
            'salgo': 'salir', 'sales': 'salir', 'sale': 'salir', 'salimos': 'salir', 'salen': 'salir',
            'salía': 'salir', 'salí': 'salir', 'salió': 'salir', 'salieron': 'salir',
            'saldré': 'salir', 'saldrá': 'salir', 'saldrán': 'salir',
            'saliendo': 'salir', 'salido': 'salir',

            // Venir
            'vengo': 'venir', 'vienes': 'venir', 'viene': 'venir', 'venimos': 'venir', 'vienen': 'venir',
            'venía': 'venir', 'vine': 'venir', 'vino': 'venir', 'vinieron': 'venir',
            'vendré': 'venir', 'vendrá': 'venir', 'vendrán': 'venir',
            'viniendo': 'venir', 'venido': 'venir',

            // Decir
            'digo': 'decir', 'dices': 'decir', 'dice': 'decir', 'decimos': 'decir', 'dicen': 'decir',
            'decía': 'decir', 'dije': 'decir', 'dijo': 'decir', 'dijeron': 'decir',
            'diré': 'decir', 'dirá': 'decir', 'dirán': 'decir',
            'diciendo': 'decir', 'dicho': 'decir',

            // Poner
            'pongo': 'poner', 'pones': 'poner', 'pone': 'poner', 'ponemos': 'poner', 'ponen': 'poner',
            'ponía': 'poner', 'puse': 'poner', 'puso': 'poner', 'pusieron': 'poner',
            'pondré': 'poner', 'pondrá': 'poner', 'pondrán': 'poner',
            'poniendo': 'poner', 'puesto': 'poner',

            // Llevar
            'llevo': 'llevar', 'llevas': 'llevar', 'lleva': 'llevar', 'llevamos': 'llevar', 'llevan': 'llevar',
            'llevaba': 'llevar', 'llevé': 'llevar', 'llevó': 'llevar', 'llevaron': 'llevar',
            'llevaré': 'llevar', 'llevará': 'llevar', 'llevarán': 'llevar',
            'llevando': 'llevar', 'llevado': 'llevar',

            // Traer
            'traigo': 'traer', 'traes': 'traer', 'trae': 'traer', 'traemos': 'traer', 'traen': 'traer',
            'traía': 'traer', 'traje': 'traer', 'trajo': 'traer', 'trajeron': 'traer',
            'traeré': 'traer', 'traerá': 'traer', 'traerán': 'traer',
            'trayendo': 'traer', 'traído': 'traer'
        };

        // Función para convertir plural a singular (español y gallego)
        function singularizar(palabra) {
            const word = palabra.toLowerCase();

            // Casos especiales
            const irregulares = {
                'macarrones': 'macarrón', 'macarróns': 'macarrón',
                'pantalones': 'pantalón', 'pantalóns': 'pantalón',
                'calcetines': 'calcetín', 'calcetíns': 'calcetín',
                'ratones': 'ratón', 'ratóns': 'ratón',
                'aviones': 'avión', 'avións': 'avión',
                'lápices': 'lápiz', 'nueces': 'nuez', 'peces': 'pez',
                'luces': 'luz', 'voces': 'voz', 'cruces': 'cruz',
                'países': 'país', 'cafés': 'café',
                'niños': 'niño', 'niñas': 'niña',
                'nenos': 'niño', 'nenas': 'niña', // gallego
                'fillos': 'hijo', 'fillas': 'hija', // gallego
                'hijos': 'hijo', 'hijas': 'hija',
                'padres': 'padre', 'madres': 'madre',
                'hermanos': 'hermano', 'hermanas': 'hermana',
                'irmáns': 'hermano', 'irmás': 'hermana', // gallego
                'amigos': 'amigo', 'amigas': 'amiga',
                'libros': 'libro', 'mesas': 'mesa', 'sillas': 'silla',
                'casas': 'casa', 'puertas': 'puerta', 'ventanas': 'ventana',
                'árboles': 'árbol', 'flores': 'flor',
                'perros': 'perro', 'gatos': 'gato', 'pájaros': 'pájaro',
                'coches': 'coche', 'trenes': 'tren',
                'días': 'día', 'noches': 'noche',
                'ojos': 'ojo', 'manos': 'mano', 'pies': 'pie',
                'dientes': 'diente', 'dedos': 'dedo'
            };

            if (irregulares[word]) return irregulares[word];

            // Reglas de singularización
            // Gallego: -óns → -ón, -áns → -án, -íns → -ín
            if (word.endsWith('óns')) return word.slice(0, -3) + 'ón';
            if (word.endsWith('áns')) return word.slice(0, -3) + 'án';
            if (word.endsWith('íns')) return word.slice(0, -3) + 'ín';
            if (word.endsWith('úns')) return word.slice(0, -3) + 'ún';

            // Español: -ones → -ón, -anes → -án, -ines → -ín
            if (word.endsWith('ones')) return word.slice(0, -4) + 'ón';
            if (word.endsWith('anes')) return word.slice(0, -4) + 'án';
            if (word.endsWith('ines')) return word.slice(0, -4) + 'ín';

            // -ces → -z (peces → pez, luces → luz)
            if (word.endsWith('ces')) return word.slice(0, -3) + 'z';

            // -s cuando el resultado acaba en vocal (grandes → grande, casas → casa)
            // Se prueba ANTES que -es para evitar falsos como grandes → grand
            if (word.endsWith('s') && !word.endsWith('ss') && word.length > 2) {
                const sinS = word.slice(0, -1);
                if ('aeiouáéíóú'.includes(sinS[sinS.length - 1])) return sinS;
            }

            // -es después de vocal+consonante (paredes → pared, colores → color)
            if (word.endsWith('es') && word.length > 3) {
                const sinEs = word.slice(0, -2);
                const ultimaLetra = sinEs[sinEs.length - 1];
                const penultimaLetra = sinEs.length > 1 ? sinEs[sinEs.length - 2] : '';
                // Solo si la penúltima es vocal (pa-red → ✓, gran-d → ✗)
                if ('dlnrsz'.includes(ultimaLetra) && 'aeiouáéíóú'.includes(penultimaLetra)) return sinEs;
            }

            // -s genérico (fallback)
            if (word.endsWith('s') && !word.endsWith('ss') && word.length > 2) {
                return word.slice(0, -1);
            }

            return palabra; // Devolver original si no hay regla
        }

        // Desflexión de adjetivos: femenino/plural/superlativo → masculino singular
        // Genera candidatos adicionales para probar en ARASAAC
        function desflexionarAdjetivo(palabra) {
            const word = palabra.toLowerCase();
            const formas = [];

            // Superlativo: -ísimo/a/os/as → base (altísimo → alto)
            const supMatch = word.match(/^(.+?)ísim[oa]s?$/);
            if (supMatch && supMatch[1].length >= 2) {
                const base = supMatch[1];
                formas.push(base + 'o', base + 'e', base);
            }

            // Femenino -a → masculino -o (roja → rojo)
            if (word.endsWith('a') && word.length > 3) {
                formas.push(word.slice(0, -1) + 'o');
            }

            // Femenino plural -as → masculino singular -o (rojas → rojo)
            if (word.endsWith('as') && word.length > 4) {
                formas.push(word.slice(0, -2) + 'o');
            }

            // Masculino plural -os → singular -o (rojos → rojo)
            if (word.endsWith('os') && word.length > 4) {
                formas.push(word.slice(0, -1));
            }

            return formas;
        }

        // Deconjugación genérica de verbos por patrón de sufijo
        // Para verbos NO listados en los diccionarios locales
        // Genera candidatos de infinitivo (-ar, -er, -ir)
        function deconjugarVerbo(palabra) {
            const w = palabra.toLowerCase();
            const formas = [];
            const vocales = 'aeiouáéíóú';

            // Gerundio: -ando → -ar, -iendo → -er/-ir
            if (w.endsWith('ando') && w.length > 5) formas.push(w.slice(0, -4) + 'ar');
            if (w.endsWith('iendo') && w.length > 6) {
                formas.push(w.slice(0, -5) + 'er', w.slice(0, -5) + 'ir');
            }

            // Participio: -ado → -ar, -ido → -er/-ir
            if (w.endsWith('ado') && w.length > 4 && !vocales.includes(w[w.length - 4])) {
                formas.push(w.slice(0, -3) + 'ar');
            }
            if (w.endsWith('ido') && w.length > 4 && !vocales.includes(w[w.length - 4])) {
                formas.push(w.slice(0, -3) + 'er', w.slice(0, -3) + 'ir');
            }

            // Imperfecto: -aba/-abas/-aban → -ar
            const impAr = w.match(/^(.{2,})(ábamos|abais|abas|aban|aba)$/);
            if (impAr) formas.push(impAr[1] + 'ar');

            // Imperfecto: -ía/-ías/-ían → -er/-ir
            const impEr = w.match(/^(.{2,})(íamos|íais|ían|ías|ía)$/);
            if (impEr) formas.push(impEr[1] + 'er', impEr[1] + 'ir');

            // Pretérito: -aste/-aron → -ar, -ieron → -er/-ir
            if (w.endsWith('aste') && w.length > 5) formas.push(w.slice(0, -4) + 'ar');
            if (w.endsWith('aron') && w.length > 5) formas.push(w.slice(0, -4) + 'ar');
            if (w.endsWith('ieron') && w.length > 6) {
                formas.push(w.slice(0, -5) + 'er', w.slice(0, -5) + 'ir');
            }

            // Presente 1ª plural: -amos → -ar, -emos → -er, -imos → -ir
            if (w.endsWith('amos') && w.length > 5) formas.push(w.slice(0, -4) + 'ar');
            if (w.endsWith('emos') && w.length > 5) formas.push(w.slice(0, -4) + 'er');
            if (w.endsWith('imos') && w.length > 5) formas.push(w.slice(0, -4) + 'ir');

            // Presente 3ª plural: -an → -ar (cantan → cantar)
            if (w.endsWith('an') && w.length > 4 && !w.match(/(ían|ban)$/)) {
                formas.push(w.slice(0, -2) + 'ar');
            }
            // -en → -er/-ir (comen → comer)
            if (w.endsWith('en') && w.length > 4 && !w.match(/(ien|yen)$/)) {
                formas.push(w.slice(0, -2) + 'er', w.slice(0, -2) + 'ir');
            }

            // Presente 2ª singular: -as → -ar, -es → -er/-ir
            if (w.endsWith('as') && w.length > 4 && !w.match(/(ías|bas)$/)) {
                formas.push(w.slice(0, -2) + 'ar');
            }
            if (w.endsWith('es') && w.length > 4 && !w.match(/(ies|yes)$/)) {
                formas.push(w.slice(0, -2) + 'er', w.slice(0, -2) + 'ir');
            }

            // Presente 3ª singular: -a → -ar (canta → cantar)
            if (w.endsWith('a') && w.length > 3 && !w.match(/(ía|ba)$/)) {
                formas.push(w.slice(0, -1) + 'ar');
            }
            // -e → -er/-ir (come → comer)
            if (w.endsWith('e') && w.length > 3 && !w.match(/(ie|ye)$/)) {
                formas.push(w.slice(0, -1) + 'er', w.slice(0, -1) + 'ir');
            }

            return [...new Set(formas)];
        }

        // Deconjugación específica de verbos gallegos
        // Patrones que difieren del español: -endo, -indo, -ou, -eu, -iu, -ades, etc.
        function deconjugarVerboGallego(palabra) {
            const w = palabra.toLowerCase();
            const formas = [];

            // Gerundio gallego: -endo → -er (comendo → comer), -indo → -ir (partindo → partir)
            if (w.endsWith('endo') && w.length > 5) formas.push(w.slice(0, -4) + 'er');
            if (w.endsWith('indo') && w.length > 5) formas.push(w.slice(0, -4) + 'ir');

            // Pretérito 3ª singular: -ou → -ar (falou → falar), -eu → -er, -iu → -ir
            if (w.endsWith('ou') && w.length > 4) formas.push(w.slice(0, -2) + 'ar');
            if (w.endsWith('eu') && w.length > 4) formas.push(w.slice(0, -2) + 'er');
            if (w.endsWith('iu') && w.length > 4) formas.push(w.slice(0, -2) + 'ir');

            // Pretérito 1ª singular: -ei → -ar (falei → falar)
            if (w.endsWith('ei') && w.length > 4) formas.push(w.slice(0, -2) + 'ar');

            // Pretérito 3ª plural: -eron → -er (comeron → comer), -iron → -ir
            if (w.endsWith('eron') && w.length > 5) formas.push(w.slice(0, -4) + 'er');
            if (w.endsWith('iron') && w.length > 5) formas.push(w.slice(0, -4) + 'ir');

            // 2ª plural presente: -ades → -ar, -edes → -er, -ides → -ir
            if (w.endsWith('ades') && w.length > 5) formas.push(w.slice(0, -4) + 'ar');
            if (w.endsWith('edes') && w.length > 5) formas.push(w.slice(0, -4) + 'er');
            if (w.endsWith('ides') && w.length > 5) formas.push(w.slice(0, -4) + 'ir');

            return [...new Set(formas)];
        }

        // Transformación morfológica gallego → español por reglas sistemáticas
        // Las dos lenguas comparten estructura: con ~20 reglas se cubren cientos de palabras
        function traducirGallegoReglas(palabra) {
            const w = palabra.toLowerCase();
            const formas = [];

            // Sufijos nominales y adjetivales (más largo primero para evitar falsos)
            const reglas = [
                // -eira(s) → -era(s): carreira→carrera, madeira→madera, escaleira→escalera
                [/eiras$/, 'eras'], [/eira$/, 'era'],
                // -eiro(s) → -ero(s): primeiro→primero, carpinteiro→carpintero
                [/eiros$/, 'eros'], [/eiro$/, 'ero'],
                // -llo(s) → -jo(s): traballo→trabajo, espello→espejo, fillo→hijo
                [/llos$/, 'jos'], [/llo$/, 'jo'],
                // -lla(s) → -ja(s): ovella→oveja, abella→abeja, filla→hija
                [/llas$/, 'jas'], [/lla$/, 'ja'],
                // -zo(s)/-za(s) → -zo/-za (iguales, pero probar -ción tb)
                // -ción = igual en ambas lenguas
                // -dade(s) → -dad(es): cidade→ciudad, liberdade→libertad
                [/dades$/, 'dades'], [/dade$/, 'dad'],
                // -anza(s) → -anza(s): confianza, esperanza (iguales)
                // -mento(s) → -miento(s): sentimento→sentimiento, movemento→movimiento
                [/imentos$/, 'imientos'], [/imento$/, 'imiento'],
                [/ementos$/, 'imientos'], [/emento$/, 'imiento'],
                [/amentos$/, 'amientos'], [/amento$/, 'amiento'],
                // -ble → -ble (igual): amable, terrible
                // -oso(s)/-osa(s) → -oso/-osa (igual): fermoso→hermoso
                // x- inicial → j-: xogar→jugar, xardín→jardín, xenro→yerno
                [/^x/, 'j'],
                // -zón → -zón: corazón (igual)
                // -ín/-iña → -ín/-iña o -ino/-ina: veciño→vecino
                [/iños$/, 'inos'], [/iño$/, 'ino'],
                [/iñas$/, 'inas'], [/iña$/, 'ina'],
                // -án/-á → -ano/-ana: irmán→hermano... irregular, skip
                // -ente → -iente: quente→caliente... irregular, in dict
                // ou → o/ue: cousa→cosa, louro→rubio... parcialmente regular
                [/ouso$/, 'oso'], [/ousa$/, 'osa'],
                // -nza → -nza (igual): confianza
                // -ería → -ería (igual): carpintería
                // -mente → -mente (igual): facilmente
                // -ción → -ción (igual)
                // -ble → -ble (igual)
            ];

            for (const [patron, reemplazo] of reglas) {
                if (patron.test(w)) {
                    const forma = w.replace(patron, reemplazo);
                    if (forma !== w) formas.push(forma);
                }
            }

            return formas;
        }

        // Función principal de normalización
        // Intenta convertir cualquier palabra a su forma de diccionario
        // IMPORTANTE: Prioriza traducciones gallego→español ANTES de la palabra original
        // para evitar falsos positivos por subcadenas (ej: "non" → "esternon")
        function normalizarPalabra(palabra) {
            const word = palabra.toLowerCase().trim();
            const formas = [];

            // 1. PRIMERO: Traducciones directas gallego → español (máxima prioridad)
            // Esto evita que "non" encuentre "esternón" o "onte" encuentre "contenedor"
            if (gallegoEspanol[word]) {
                const traduccion = gallegoEspanol[word];
                formas.push(traduccion);
                // Para contracciones multi-palabra ("no"→"en el"), separar y buscar
                // cada parte individualmente, descartando artículos
                if (traduccion.includes(' ')) {
                    const articulosEs = ['el', 'la', 'los', 'las', 'un', 'una'];
                    traduccion.split(' ').forEach(p => {
                        if (!articulosEs.includes(p)) formas.push(p);
                    });
                }
            }

            // 2. Verbos gallegos conjugados → infinitivo español
            if (verbosGallegoInfinitivo[word]) {
                formas.push(verbosGallegoInfinitivo[word]);
            }
            if (verbosGallegoAdicionales[word]) {
                formas.push(verbosGallegoAdicionales[word]);
            }

            // 3. Verbos españoles conjugados → infinitivo
            if (verbosEspanolInfinitivo[word]) {
                formas.push(verbosEspanolInfinitivo[word]);
            }

            // 4. Singularización (antes de la palabra original)
            const singular = singularizar(word);
            if (singular !== word) {
                formas.push(singular);
                // También traducir el singular
                if (gallegoEspanol[singular]) {
                    formas.push(gallegoEspanol[singular]);
                }
                // 4b. Para palabras en -es, probar también quitando -es como sufijo
                // (paredes → parede por regla -s, pero también probar pared)
                if (word.endsWith('es') && word.length > 4) {
                    const sinEs = word.slice(0, -2);
                    if (sinEs !== singular) formas.push(sinEs);
                }
            }

            // 5. Forma original (saltar si es contracción gallega en texto gallego)
            // Ej: "no" gallego = "en el" → no buscar "no" español (negación)
            const traduccionDirecta = gallegoEspanol[word];
            const esContraccionGallega = state.esGallego && traduccionDirecta && traduccionDirecta.includes(' ');
            if (!esContraccionGallega) {
                formas.push(word);
            }

            // Helper: añadir forma + su traducción gallego→español si existe
            function addConTraduccion(forma) {
                formas.push(forma);
                if (gallegoEspanol[forma]) formas.push(gallegoEspanol[forma]);
            }

            // 6. Desflexión de adjetivos (roja → rojo, vermella → vermello → rojo)
            desflexionarAdjetivo(word).forEach(addConTraduccion);

            // 7. Deconjugación genérica de verbos (español + gallego)
            // Solo si no se encontró en los diccionarios de verbos (pasos 2-3)
            if (!verbosGallegoInfinitivo[word] && !verbosGallegoAdicionales[word] && !verbosEspanolInfinitivo[word]) {
                deconjugarVerbo(word).forEach(addConTraduccion);
                deconjugarVerboGallego(word).forEach(addConTraduccion);
            }

            // 8. Transformación morfológica gallego → español por reglas
            // Cubre cientos de palabras sin necesidad de diccionario explícito
            traducirGallegoReglas(word).forEach(f => formas.push(f));
            // También aplicar reglas al singular (carreiras → carreira → carrera)
            if (singular !== word) {
                traducirGallegoReglas(singular).forEach(f => formas.push(f));
            }

            // 9. Sin acentos (última opción)
            const sinAcentos = word.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            if (sinAcentos !== word) {
                formas.push(sinAcentos);
            }

            // Eliminar duplicados y mantener orden de prioridad
            return [...new Set(formas)];
        }

        // Cache de pictogramas para evitar llamadas repetidas
        const pictoCache = new Map();

        // Buscar pictograma en API oficial ARASAAC
        // IMPORTANTE: Solo acepta resultados con coincidencia EXACTA de keyword
        // Devuelve objeto con URL principal y alternativas
        async function searchArasaacAPI(word) {
            // Verificar cache primero
            if (pictoCache.has(word)) {
                return pictoCache.get(word);
            }

            try {
                const url = `https://api.arasaac.org/api/pictograms/es/search/${encodeURIComponent(word)}`;
                const arasaacController = new AbortController();
                const arasaacTimeout = setTimeout(() => arasaacController.abort(), 8000);
                const response = await fetch(url, { signal: arasaacController.signal });
                clearTimeout(arasaacTimeout);
                if (!response.ok) {
                    pictoCache.set(word, null);
                    return null;
                }

                const data = await response.json();
                if (!data || data.length === 0) {
                    pictoCache.set(word, null);
                    return null;
                }

                // CRÍTICO: Filtrar SOLO pictogramas con coincidencia EXACTA de keyword
                const exactMatches = data.filter(picto =>
                    picto.keywords?.some(k =>
                        k.keyword?.toLowerCase() === word.toLowerCase()
                    )
                );

                if (exactMatches.length === 0) {
                    pictoCache.set(word, null);
                    return null;
                }

                // Ordenar por puntuación (AAC y esquemáticos primero)
                const scored = exactMatches.map(picto => {
                    let score = 0;
                    if (picto.aac) score += 10;
                    if (picto.schematic) score += 5;
                    return { picto, score };
                }).sort((a, b) => b.score - a.score);

                // Construir resultado con alternativas (máximo 6)
                const alternatives = scored.slice(0, 6).map(({ picto }) => ({
                    id: picto._id,
                    url: `https://static.arasaac.org/pictograms/${picto._id}/${picto._id}_500.png`
                }));

                const result = {
                    url: alternatives[0].url,
                    alternatives: alternatives
                };

                pictoCache.set(word, result);
                return result;

            } catch (error) {
                console.error('Error buscando pictograma:', word, error);
                pictoCache.set(word, null);
                return null;
            }
        }

        // Llamar a la API de lematización SpaCy
        async function lemmatizeWords(words) {
            try {
                // Timeout de 5s: si SpaCy no responde rápido, fallback local
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`${LEMMATIZER_API}/lemmatize/words`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ words }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    console.warn('API lematización: respuesta no OK', response.status);
                    return null;
                }
                const data = await response.json();
                console.log('Lemas recibidos:', data.results);
                return data.results;
            } catch (error) {
                console.warn('API de lematización no disponible:', error.message);
                return null;
            }
        }

        // Función principal de búsqueda
        // Prueba: 1) lema de SpaCy, 2) formas normalizadas locales
        async function searchPicto(word) {
            const wordLower = word.toLowerCase().trim();

            // Ignorar palabras de 1 sola letra
            if (wordLower.length <= 1) {
                return null;
            }

            // Prioridad 1: Si tenemos lema de SpaCy, usarlo primero
            if (state.lemmas.has(wordLower)) {
                const lemma = state.lemmas.get(wordLower);
                const result = await searchArasaacAPI(lemma);
                if (result) {
                    if (lemma !== wordLower) {
                        state.translations.set(wordLower, lemma);
                    }
                    return result;
                }
            }

            // Prioridad 2: Formas normalizadas locales (diccionarios)
            const formas = normalizarPalabra(wordLower);

            for (const forma of formas) {
                const result = await searchArasaacAPI(forma);
                if (result) {
                    if (forma !== wordLower) {
                        state.translations.set(wordLower, forma);
                    }
                    return result;
                }
            }

            return null;
        }

        // Búsqueda en lote para mayor eficiencia
        async function searchPictosBatch(words) {
            const uniqueWords = [...new Set(words.map(w => w.toLowerCase()))];
            const results = new Map();

            // Procesar en paralelo con límite de concurrencia
            const BATCH_SIZE = 5;
            for (let i = 0; i < uniqueWords.length; i += BATCH_SIZE) {
                const batch = uniqueWords.slice(i, i + BATCH_SIZE);
                const promises = batch.map(async word => {
                    const url = await searchPicto(word);
                    results.set(word, url);
                });
                await Promise.all(promises);
            }

            return results;
        }

        // Gestión del tema
        function updateThemeIcons() {
            if (state.darkMode) {
                document.documentElement.classList.add('dark');
                elements.moonIcon.classList.add('hidden');
                elements.sunIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                elements.moonIcon.classList.remove('hidden');
                elements.sunIcon.classList.add('hidden');
            }
        }

        function toggleTheme() {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', state.darkMode);
            updateThemeIcons();
        }

        // Cargar archivo .docx
        async function loadDocxFile(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                elements.textInput.value = result.value;
                elements.fileName.textContent = file.name;
                elements.fileName.classList.remove('hidden');
                showToast('Documento cargado', 'success');
            } catch (error) {
                showToast('Error al cargar el documento', 'error');
            }
        }

        // Renderizar palabras
        function renderWords() {
            elements.wordContainer.innerHTML = '';
            state.tokens.forEach((token, index) => {
                if (token.type === 'newline') {
                    elements.wordContainer.appendChild(document.createElement('br'));
                    return;
                }
                const span = document.createElement('span');
                span.textContent = token.value;
                span.dataset.index = index;
                if (token.type === 'word') {
                    span.className = 'word-token' + (state.selectedWords.has(index) ? ' selected' : '');
                    span.addEventListener('click', () => toggleWordSelection(index));
                } else {
                    span.className = 'word-token punctuation';
                }
                elements.wordContainer.appendChild(span);
            });
            updateConvertButton();
        }

        function toggleWordSelection(index) {
            state.selectedWords.has(index) ? state.selectedWords.delete(index) : state.selectedWords.add(index);
            renderWords();
        }

        function selectAllWords() {
            const allSelected = state.tokens.filter(t => t.type === 'word').length === state.selectedWords.size;
            if (allSelected) {
                state.selectedWords.clear();
            } else {
                state.tokens.forEach((token, index) => {
                    if (token.type === 'word') state.selectedWords.add(index);
                });
            }
            renderWords();
        }

        function updateConvertButton() {
            elements.convertBtn.disabled = state.selectedWords.size === 0;
        }

        // Convertir a pictogramas (optimizado con búsqueda en lote)
        async function convertToPictos() {
            showStep(3);
            elements.loadingState.classList.remove('hidden');
            elements.previewContainer.classList.add('hidden');

            // Detectar idioma antes de normalizar
            state.esGallego = detectarIdioma(state.tokens);

            const selectedTokens = Array.from(state.selectedWords).map(idx => state.tokens[idx].value);
            const uniqueWords = [...new Set(selectedTokens.map(w => w.toLowerCase()))];

            // Filtrar palabras que ya tenemos en cache
            const wordsToSearch = uniqueWords.filter(w => !state.pictos.has(w));

            if (wordsToSearch.length === 0) {
                elements.loadingState.classList.add('hidden');
                elements.previewContainer.classList.remove('hidden');
                renderPreview();
                return;
            }

            // Paso 1: Obtener lemas del servidor SpaCy (si está disponible)
            elements.loadingText.textContent = 'Analizando palabras...';
            elements.progressBar.style.width = '5%';

            const lemmaResults = await lemmatizeWords(wordsToSearch);
            if (lemmaResults) {
                lemmaResults.forEach(r => {
                    const original = r.original.toLowerCase();
                    if (r.lemma && r.lemma !== original) {
                        state.lemmas.set(original, r.lemma);
                    }
                });
            }

            elements.loadingText.textContent = `Buscando ${wordsToSearch.length} pictogramas...`;
            elements.progressBar.style.width = '10%';

            // Paso 2: Búsqueda en paralelo con límite de concurrencia
            const BATCH_SIZE = 8;
            let completed = 0;

            for (let i = 0; i < wordsToSearch.length; i += BATCH_SIZE) {
                const batch = wordsToSearch.slice(i, i + BATCH_SIZE);
                elements.loadingText.textContent = `Buscando: ${batch.join(', ')}`;

                const promises = batch.map(async word => {
                    const result = await searchPicto(word);
                    state.pictos.set(word, result);
                    completed++;
                    elements.progressBar.style.width = `${10 + (completed / wordsToSearch.length) * 90}%`;
                });

                await Promise.all(promises);
            }

            elements.loadingState.classList.add('hidden');
            elements.previewContainer.classList.remove('hidden');
            renderPreview();

            // Mostrar estadísticas
            const found = Array.from(state.pictos.values()).filter(v => v && v.url).length;
            const total = state.pictos.size;
            if (found < total) {
                showToast(`${found}/${total} pictogramas encontrados`, 'info');
            }
        }

        // Renderizar previsualización
        // Nota: innerHTML es seguro aquí porque los datos vienen de ARASAAC (API confiable)
        // y del texto del usuario (no ejecutable)
        function renderPreview() {
            let html = '';
            state.tokens.forEach((token, index) => {
                if (token.type === 'newline') { html += '<br>'; return; }
                if (token.type === 'word' && state.selectedWords.has(index)) {
                    const word = token.value.toLowerCase();
                    const pictoData = state.pictos.get(word);
                    const translation = state.translations.get(word);
                    const captionText = translation && translation !== word ? `${token.value} (${translation})` : token.value;

                    if (pictoData && pictoData.url) {
                        const hasAlternatives = pictoData.alternatives && pictoData.alternatives.length > 1;
                        html += `<span class="picto-container" data-word="${word}">
                            ${hasAlternatives ? `<button class="picto-change-btn" onclick="showAlternatives('${word}')" title="Cambiar pictograma">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                    <path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
                                    <path d="M16 16h5v5"/>
                                </svg>
                            </button>` : ''}
                            <img src="${pictoData.url}" alt="${token.value}" class="picto-image" style="width:${state.pictoSize}px;height:${state.pictoSize}px;object-fit:contain;">
                            <span class="picto-caption">${captionText}</span>
                        </span>`;
                    } else {
                        html += `<span class="no-picto">${token.value}</span> `;
                    }
                } else {
                    html += token.value + (token.type === 'word' ? ' ' : '');
                }
            });
            elements.previewDocument.innerHTML = html;
        }

        // Mostrar modal de alternativas (mismo patrón que settingsModal)
        function showAlternatives(word) {
            const pictoData = state.pictos.get(word);
            if (!pictoData || !pictoData.alternatives) return;

            const modal = document.getElementById('alternativesModal');
            const grid = document.getElementById('alternativesGrid');
            document.getElementById('alternativesWord').textContent = word;

            // Construir grid de alternativas con DOM seguro
            grid.replaceChildren();
            pictoData.alternatives.forEach(alt => {
                const btn = document.createElement('button');
                btn.className = 'alt-picto' + (alt.url === pictoData.url ? ' selected' : '');
                btn.onclick = () => selectAlternative(word, alt.url);
                const img = document.createElement('img');
                img.src = alt.url;
                img.alt = word;
                btn.appendChild(img);
                grid.appendChild(btn);
            });

            modal.classList.add('visible');
        }

        // Seleccionar alternativa
        function selectAlternative(word, newUrl) {
            const pictoData = state.pictos.get(word);
            if (pictoData) {
                pictoData.url = newUrl;
                state.pictos.set(word, pictoData);
            }
            closeAlternativesModal();
            renderPreview();
        }

        // Cerrar modal de alternativas
        function closeAlternativesModal() {
            document.getElementById('alternativesModal').classList.remove('visible');
        }

        // Exportar a .docx
        async function downloadDocx() {
            try {
                showToast('Generando documento...', 'info');
                const { Document, Paragraph, TextRun, ImageRun, Packer } = window.docx;
                const children = [];
                let currentParagraphChildren = [];
                const imageCache = new Map();

                for (let i = 0; i < state.tokens.length; i++) {
                    const token = state.tokens[i];
                    if (token.type === 'word' && state.selectedWords.has(i)) {
                        const pictoData = state.pictos.get(token.value.toLowerCase());
                        if (pictoData && pictoData.url && !imageCache.has(pictoData.url)) {
                            try {
                                const response = await fetch(pictoData.url);
                                const blob = await response.blob();
                                imageCache.set(pictoData.url, await blob.arrayBuffer());
                            } catch {}
                        }
                    }
                }

                for (let i = 0; i < state.tokens.length; i++) {
                    const token = state.tokens[i];
                    if (token.type === 'newline') {
                        if (currentParagraphChildren.length > 0) {
                            children.push(new Paragraph({ children: currentParagraphChildren }));
                            currentParagraphChildren = [];
                        }
                        children.push(new Paragraph({ children: [] }));
                        continue;
                    }
                    if (token.type === 'word' && state.selectedWords.has(i)) {
                        const pictoData = state.pictos.get(token.value.toLowerCase());
                        const imageData = pictoData ? imageCache.get(pictoData.url) : null;
                        if (imageData) {
                            currentParagraphChildren.push(new ImageRun({ data: imageData, transformation: { width: state.pictoSize, height: state.pictoSize } }));
                            currentParagraphChildren.push(new TextRun({ text: `(${token.value}) `, size: 18, color: '666666' }));
                        } else {
                            currentParagraphChildren.push(new TextRun({ text: token.value + ' ', italics: true, color: '666666' }));
                        }
                    } else {
                        currentParagraphChildren.push(new TextRun({ text: token.type === 'word' ? token.value + ' ' : token.value, size: 24 }));
                    }
                }
                if (currentParagraphChildren.length > 0) children.push(new Paragraph({ children: currentParagraphChildren }));

                const doc = new Document({ sections: [{ children }] });
                const blob = await Packer.toBlob(doc);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'actividad-con-pictos.docx';
                a.click();
                URL.revokeObjectURL(url);
                showToast('Documento descargado', 'success');
            } catch (error) {
                showToast('Error al generar el documento', 'error');
            }
        }

        // Exportar a PDF
        async function downloadPdf() {
            try {
                showToast('Preparando PDF...', 'info');
                const printContainer = document.createElement('div');
                printContainer.id = 'printContainer';
                printContainer.style.position = 'absolute';
                printContainer.style.left = '-9999px';
                document.body.appendChild(printContainer);

                // Reconstruir contenido sin botones de cambiar picto
                const source = elements.previewDocument.cloneNode(true);
                source.querySelectorAll('.picto-change-btn').forEach(btn => btn.remove());
                printContainer.appendChild(source);

                // Convertir imágenes externas a data URL para impresión fiable
                const images = printContainer.querySelectorAll('img');
                await Promise.all(Array.from(images).map(img => new Promise(resolve => {
                    if (!img.src || img.complete) { resolve(); return; }
                    const newImg = new Image();
                    newImg.crossOrigin = 'anonymous';
                    newImg.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = newImg.naturalWidth;
                        canvas.height = newImg.naturalHeight;
                        canvas.getContext('2d').drawImage(newImg, 0, 0);
                        try { img.src = canvas.toDataURL('image/png'); } catch(e) { /* CORS fallback: mantener URL original */ }
                        resolve();
                    };
                    newImg.onerror = resolve;
                    newImg.src = img.src;
                })));

                // Posicionar para impresión
                printContainer.style.position = '';
                printContainer.style.left = '';

                alert('Para un PDF limpio:\n\n1. Pulsa "Más opciones"\n2. Desmarca "Encabezados y pies de página"\n3. Selecciona "Guardar como PDF"');

                const cleanup = () => { printContainer.remove(); window.removeEventListener('afterprint', cleanup); };
                window.addEventListener('afterprint', cleanup);
                window.print();
            } catch (error) {
                showToast('Error al generar el PDF', 'error');
            }
        }

        // Navegación entre pasos
        function showStep(step) {
            [elements.step1, elements.step2, elements.step3].forEach(s => s.classList.add('hidden'));
            [elements.stepDot1, elements.stepDot2, elements.stepDot3].forEach((d, i) => {
                d.classList.remove('active', 'completed');
                if (i + 1 < step) d.classList.add('completed');
                if (i + 1 === step) d.classList.add('active');
            });
            if (step === 1) elements.step1.classList.remove('hidden');
            if (step === 2) elements.step2.classList.remove('hidden');
            if (step === 3) elements.step3.classList.remove('hidden');
        }

        function loadText() {
            const text = elements.textInput.value.trim();
            if (!text) { showToast('Introduce o carga un texto', 'error'); return; }
            state.text = text;
            state.tokens = tokenizeText(text);
            state.selectedWords.clear();
            showStep(2);
            renderWords();
        }

        // Modal de configuración
        function openSettings() {
            elements.settingsModal.classList.add('visible');
            document.querySelectorAll('input[name="pictoSize"]').forEach(r => r.checked = parseInt(r.value) === state.pictoSize);
        }

        function closeSettings() { elements.settingsModal.classList.remove('visible'); }

        function saveSettings() {
            const selected = document.querySelector('input[name="pictoSize"]:checked');
            if (selected) {
                state.pictoSize = parseInt(selected.value);
                localStorage.setItem('pictoSize', state.pictoSize);
                if (!elements.previewContainer.classList.contains('hidden')) renderPreview();
            }
            closeSettings();
            showToast('Configuración guardada', 'success');
        }

        // Event Listeners
        elements.themeToggle.addEventListener('click', toggleTheme);
        elements.dropzone.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', e => e.target.files.length && loadDocxFile(e.target.files[0]));
        elements.dropzone.addEventListener('dragover', e => { e.preventDefault(); elements.dropzone.classList.add('dragover'); });
        elements.dropzone.addEventListener('dragleave', () => elements.dropzone.classList.remove('dragover'));
        elements.dropzone.addEventListener('drop', e => {
            e.preventDefault();
            elements.dropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                const file = e.dataTransfer.files[0];
                file.name.endsWith('.docx') ? loadDocxFile(file) : showToast('Solo archivos .docx', 'error');
            }
        });

        elements.loadTextBtn.addEventListener('click', loadText);
        elements.backToStep1Btn.addEventListener('click', () => showStep(1));
        elements.backToStep2Btn.addEventListener('click', () => showStep(2));
        elements.selectAllBtn.addEventListener('click', selectAllWords);
        elements.convertBtn.addEventListener('click', convertToPictos);
        elements.downloadDocxBtn.addEventListener('click', downloadDocx);
        elements.downloadPdfBtn.addEventListener('click', downloadPdf);
        elements.settingsBtn.addEventListener('click', openSettings);
        elements.closeModalBtn.addEventListener('click', closeSettings);
        elements.cancelSettingsBtn.addEventListener('click', closeSettings);
        elements.saveSettingsBtn.addEventListener('click', saveSettings);
        document.addEventListener('keydown', e => e.key === 'Escape' && elements.settingsModal.classList.contains('visible') && closeSettings());
        elements.settingsModal.addEventListener('click', e => e.target === elements.settingsModal && closeSettings());

        // Cerrar modal alternativas con click fuera o Escape
        const altModal = document.getElementById('alternativesModal');
        altModal.addEventListener('click', e => e.target === altModal && closeAlternativesModal());
        document.addEventListener('keydown', e => e.key === 'Escape' && altModal.classList.contains('visible') && closeAlternativesModal());

        // Inicialización
        updateThemeIcons();
    </script>
</body>
</html>
